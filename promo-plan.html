
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MDSL - D2C Promo Plan</title></title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Bebas+Neue&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #e5e5e5;
    --surface: #ffffff;
    --surface2: #f0f0f0;
    --surface3: #f6f6f6;
    --border: #d0d0d0;
    --border-strong: #b0b0b0;
    --accent: #1e1e1e;
    --accent2: #4a55c8;
    --text: #1a1a1a;
    --text-muted: #777777;
    --text-light: #aaaaaa;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans KR', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    line-height: 1.6;
  }

  /* â”€â”€ Top Bar â”€â”€ */
  .topbar {
    position: sticky; top: 0; z-index: 100;
    background: rgba(255,255,255,0.96);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex; align-items: center; justify-content: space-between;
    height: 60px;
    box-shadow: 0 1px 8px rgba(0,0,0,0.07);
  }
  .topbar-left { display: flex; align-items: center; gap: 16px; }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--accent); letter-spacing: 3px; }
  .month-selector { display: flex; align-items: center; gap: 8px; }
  .month-selector select {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 6px 12px; border-radius: 6px;
    font-family: 'Noto Sans KR', sans-serif; font-size: 13px; cursor: pointer;
  }
  .topbar-right { display: flex; align-items: center; gap: 10px; }
  .btn {
    padding: 8px 18px; border-radius: 8px; border: none; cursor: pointer;
    font-family: 'Noto Sans KR', sans-serif; font-size: 13px; font-weight: 500;
    transition: all 0.2s;
  }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #333; }
  .btn-share { background: #fff; border: 1px solid var(--accent2); color: var(--accent2); }
  .btn-share:hover { background: var(--accent2); color: #fff; }

  /* â”€â”€ Share Toast â”€â”€ */
  .toast {
    position: fixed; top: 80px; right: 32px; z-index: 999;
    background: #fff; border: 1px solid var(--accent2); border-radius: 10px;
    padding: 14px 20px; min-width: 300px;
    transform: translateX(120%); transition: transform 0.3s ease;
    box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  }
  .toast.show { transform: translateX(0); }
  .toast-title { font-size: 13px; font-weight: 600; color: var(--accent2); margin-bottom: 8px; }
  .toast-url {
    font-size: 11px; color: var(--text-muted); background: var(--surface2);
    padding: 8px 10px; border-radius: 6px; word-break: break-all;
    cursor: pointer; transition: color 0.2s;
  }
  .toast-url:hover { color: var(--text); }
  .toast-hint { font-size: 11px; color: var(--text-light); margin-top: 6px; }

  /* â”€â”€ Layout â”€â”€ */
  .container { max-width: 1300px; margin: 0 auto; padding: 40px 32px; }

  /* â”€â”€ Section Header â”€â”€ */
  .section-header { display: flex; align-items: center; gap: 16px; margin-bottom: 28px; }
  .section-tag {
    font-family: 'Bebas Neue', sans-serif; font-size: 11px; letter-spacing: 3px;
    color: var(--accent); background: var(--surface);
    padding: 4px 12px; border-radius: 4px; border: 1px solid var(--border-strong);
  }
  .section-title { font-family: 'DM Serif Display', serif; font-size: 26px; color: var(--text); font-weight: 400; }
  .section-divider { flex: 1; height: 1px; background: var(--border); }

  /* â”€â”€ Calendar â”€â”€ */
  .calendar-wrap {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden; margin-bottom: 60px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.06);
  }
  .calendar-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 24px; border-bottom: 1px solid var(--border);
    background: var(--surface3); flex-wrap: wrap; gap: 12px;
  }
  .calendar-month-title {
    font-family: 'Bebas Neue', sans-serif; font-size: 32px;
    color: var(--accent); letter-spacing: 4px;
  }
  .cal-legend { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
  .cal-legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-muted); }
  .legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }
  .legend-hint {
    display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-light);
    border-left: 1px solid var(--border); padding-left: 10px; margin-left: 4px;
  }
  .legend-chip-ev {
    font-size: 9px; padding: 1px 7px; border-radius: 3px;
    background: rgba(232,132,90,0.18); color: #c06030; font-weight: 600;
  }
  .legend-chip-ig {
    font-size: 9px; padding: 1px 6px; border-radius: 3px;
    border: 1.5px dashed #c87a9a; color: #c87a9a; font-weight: 500;
  }
  .legend-chip-crm {
    font-size: 9px; padding: 1px 6px; border-radius: 3px;
    border: 1.5px solid #8a7ec8; color: #8a7ec8; font-weight: 600;
    background: repeating-linear-gradient(45deg,#8a7ec830,#8a7ec830 2px,transparent 2px,transparent 5px);
  }

  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }

  .cal-day-label {
    text-align: center; padding: 10px 4px;
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    letter-spacing: 1px; text-transform: uppercase;
    border-bottom: 1px solid var(--border);
    background: var(--surface3);
  }
  .cal-day-label:first-child { color: #c83030; }
  .cal-day-label:last-child  { color: var(--accent2); }

  .cal-cell {
    /* ë„‰ë„‰í•œ ë†’ì´ â€” 2ì¤„ chipì´ ì—¬ëŸ¬ ê°œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ */
    min-height: 160px;
    padding: 8px 6px 34px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    position: relative; background: var(--surface);
  }
  .cal-cell:nth-child(7n) { border-right: none; }
  .cal-cell.empty { background: var(--surface3); }
  .cal-cell.today { background: #fffbee; }
  .cal-cell.today .day-num { color: #b07010; font-weight: 700; }

  .day-num {
    font-size: 12px; font-weight: 600; color: var(--text-muted);
    margin-bottom: 5px; display: block;
  }
  .cal-cell:nth-child(7n+1) .day-num { color: #c83030; }
  .cal-cell:nth-child(7n)   .day-num { color: var(--accent2); }

  .cal-events { display: flex; flex-direction: column; gap: 3px; }

  /* â”€â”€ Chip: 2ì¤„ í—ˆìš© â”€â”€ */
  .cal-event-chip {
    font-size: 10px;
    padding: 3px 7px;
    border-radius: 4px;
    cursor: pointer;
    line-height: 1.45;
    max-width: 100%;
    transition: opacity 0.15s;
    /* 2ì¤„ê¹Œì§€ ë³´ì´ê¸° */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    white-space: normal;
    word-break: break-all;
  }
  .cal-event-chip:hover { opacity: 0.7; }

  /* ì´ë²¤íŠ¸: ì±„ìš´ ë°°ê²½ */
  .type-event {
    font-weight: 500;
  }
  /* ì¸ìŠ¤íƒ€ê·¸ë¨: ì ì„  í…Œë‘ë¦¬, íˆ¬ëª… ë°°ê²½ */
  .type-ig {
    background: transparent !important;
    border-width: 1.5px;
    border-style: dashed;
    font-weight: 400;
  }
  /* CRM: ì‹¤ì„  í…Œë‘ë¦¬ + ì—°í•œ ì¤„ë¬´ëŠ¬ ë°°ê²½ */
  .type-crm {
    border-width: 1.5px;
    border-style: solid;
    font-weight: 600;
    letter-spacing: 0.2px;
  }

  /* add chip btn */
  .add-event-btn {
    position: absolute; bottom: 6px; right: 6px;
    width: 22px; height: 22px; border-radius: 5px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text-muted); font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; opacity: 0; transition: opacity 0.15s; line-height: 1;
  }
  .cal-cell:hover .add-event-btn { opacity: 1; }
  .add-event-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

  /* â”€â”€ Event Detail: full-width cards, ì¢Œ/ìš° 2ë‹¨ â”€â”€ */
  .events-list { display: flex; flex-direction: column; gap: 28px; margin-bottom: 60px; }

  .event-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    transition: box-shadow 0.2s;
  }
  .event-card:hover { box-shadow: 0 4px 24px rgba(0,0,0,0.09); }
  .event-card-top { height: 5px; }

  /* 2ë‹¨ ë‚´ë¶€ ë ˆì´ì•„ì›ƒ â€” ì˜¤ë¥¸ìª½(ë ˆí¼ëŸ°ìŠ¤) ë” ë„“ê²Œ */
  .event-card-inner {
    display: grid;
    grid-template-columns: 480px 1fr;
  }
  @media(max-width:1060px) { .event-card-inner { grid-template-columns: 1fr; } }

  .event-card-left {
    padding: 28px;
    border-right: 1px solid var(--border);
  }
  @media(max-width:1060px) { .event-card-left { border-right: none; border-bottom: 1px solid var(--border); } }

  /* ìš°ì¸¡: ë ˆí¼ëŸ°ìŠ¤ ë©”ëª¨ â€” ì¶©ë¶„í•œ ë†’ì´ */
  .event-card-right {
    padding: 24px;
    background: var(--surface3);
    display: flex; flex-direction: column;
    min-height: 460px;
  }

  .event-card-header {
    display: flex; align-items: flex-start;
    justify-content: space-between; margin-bottom: 20px;
  }
  .event-number {
    font-family: 'Bebas Neue', sans-serif; font-size: 44px;
    color: var(--border-strong); line-height: 1; margin-right: 16px;
  }
  .event-title-block { flex: 1; }
  .event-theme-tag {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--text-light); margin-bottom: 4px;
  }
  .event-title-input {
    font-family: 'DM Serif Display', serif; font-size: 22px;
    background: transparent; border: none; color: var(--text);
    width: 100%; outline: none;
    border-bottom: 1px solid transparent; transition: border-color 0.2s;
  }
  .event-title-input:focus { border-bottom-color: var(--accent); }
  .event-title-input::placeholder { color: var(--text-light); }

  .event-del-btn {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-muted); width: 28px; height: 28px;
    border-radius: 6px; cursor: pointer; font-size: 14px;
    transition: all 0.2s; flex-shrink: 0;
  }
  .event-del-btn:hover { background: #ffeaea; border-color: #c83030; color: #c83030; }

  .field-group { margin-bottom: 16px; }
  .field-label {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--text-muted); margin-bottom: 6px; display: block; font-weight: 700;
  }
  .field-input, .field-textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); border-radius: 8px;
    font-family: 'Noto Sans KR', sans-serif; font-size: 13px;
    outline: none; transition: border-color 0.2s, background 0.2s;
  }
  .field-input { padding: 10px 14px; }
  .field-textarea { padding: 12px 14px; resize: none; min-height: 90px; line-height: 1.7; overflow: hidden; }
  .field-input:focus, .field-textarea:focus { border-color: var(--accent); background: #fff; }
  .field-input::placeholder, .field-textarea::placeholder { color: var(--text-light); }
  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .color-picker-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .color-swatch {
    width: 24px; height: 24px; border-radius: 6px;
    cursor: pointer; border: 2px solid transparent; transition: all 0.15s;
  }
  .color-swatch.active {
    border-color: #333; transform: scale(1.2);
    box-shadow: 0 0 0 2px #fff, 0 0 0 4px #333;
  }

  /* â”€â”€ Reference Panel â”€â”€ */
  .ref-panel-title {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
    color: var(--text-muted); font-weight: 700; margin-bottom: 10px;
    display: flex; align-items: center; gap: 6px;
  }
  .ref-toolbar {
    display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;
  }
  .ref-tool-btn {
    padding: 5px 11px; font-size: 11px; border-radius: 6px;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text-muted); cursor: pointer; transition: all 0.15s;
    font-family: 'Noto Sans KR', sans-serif; white-space: nowrap;
  }
  .ref-tool-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }

  /* contenteditable ref area â€” flexes to fill right panel */
  .ref-editor {
    flex: 1;
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow-y: auto;
    min-height: 320px;
    padding: 14px 16px;
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 13px;
    line-height: 1.85;
    color: var(--text);
    outline: none;
    position: relative;
    transition: border-color 0.2s;
  }
  .ref-editor:focus { border-color: var(--accent); }
  /* Placeholder via data attr */
  .ref-editor[data-empty="true"]::before {
    content: attr(data-placeholder);
    color: var(--text-light);
    pointer-events: none;
    position: absolute; top: 14px; left: 16px;
    font-size: 13px; line-height: 1.85;
    white-space: pre-line;
  }
  /* images in ref */
  .ref-editor img {
    max-width: 100%; border-radius: 6px;
    margin: 8px 0; display: block; cursor: pointer;
    transition: outline 0.1s;
  }
  .ref-editor img:hover { outline: 2px solid var(--accent2); outline-offset: 2px; }

  /* â”€â”€ Add Event Card â”€â”€ */
  .add-event-card {
    background: var(--surface); border: 2px dashed var(--border);
    border-radius: var(--radius); min-height: 72px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s;
    color: var(--text-muted); font-size: 13px; gap: 10px;
  }
  .add-event-card:hover { border-color: var(--accent); color: var(--accent); background: #fafafa; }

  /* â”€â”€ Modal â”€â”€ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.show { opacity: 1; pointer-events: all; }
  .modal {
    background: #fff; border: 1px solid var(--border);
    border-radius: 16px; padding: 32px; width: 460px; max-width: 95vw;
    transform: translateY(20px); transition: transform 0.2s;
    box-shadow: 0 12px 48px rgba(0,0,0,0.14);
  }
  .modal-overlay.show .modal { transform: translateY(0); }
  .modal-title { font-family: 'DM Serif Display', serif; font-size: 22px; margin-bottom: 24px; color: var(--text); }
  .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 24px; }

  /* Pill-style type toggle */
  .type-toggle {
    display: flex; border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden; margin-bottom: 18px;
  }
  .type-toggle input[type="radio"] { display: none; }
  .type-toggle label {
    flex: 1; text-align: center; padding: 10px 0;
    font-size: 13px; cursor: pointer;
    background: var(--surface2); color: var(--text-muted);
    transition: all 0.15s; user-select: none;
  }
  .type-toggle label:not(:last-child) { border-right: 1px solid var(--border); }
  .type-toggle input[type="radio"]:checked + label {
    background: var(--accent); color: #fff; font-weight: 600;
  }

  .color-note {
    margin-top: 8px; font-size: 11px; color: var(--text-muted);
    display: flex; gap: 12px; align-items: center;
  }
  .color-note-chip {
    padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
  }

  /* â”€â”€ Save status â”€â”€ */
  .save-status { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 6px; }
  .save-dot { width: 6px; height: 6px; border-radius: 50%; background: #5ab86a; }
  .save-dot.saving { background: #d09030; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .page-footer {
    text-align: center; padding: 40px 20px;
    border-top: 1px solid var(--border);
    color: var(--text-light); font-size: 12px;
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--border-strong); }
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <div class="topbar-left">
    <div class="logo">PROMO PLAN</div>
    <div class="month-selector">
      <select id="yearSel"></select>
      <select id="monthSel">
        <option value="0">1ì›”</option><option value="1">2ì›”</option><option value="2">3ì›”</option>
        <option value="3">4ì›”</option><option value="4">5ì›”</option><option value="5">6ì›”</option>
        <option value="6">7ì›”</option><option value="7">8ì›”</option><option value="8">9ì›”</option>
        <option value="9">10ì›”</option><option value="10">11ì›”</option><option value="11">12ì›”</option>
      </select>
    </div>
    <div class="save-status">
      <div class="save-dot" id="saveDot"></div>
      <span id="saveLabel">ì €ì¥ë¨</span>
      <span id="saveTime" style="color:var(--text-light);font-size:11px"></span>
    </div>
  </div>
  <div class="topbar-right">
    <button class="btn btn-outline" onclick="clearAll()">ì´ˆê¸°í™”</button>
    <button class="btn btn-share" onclick="shareURL()">ğŸ”— URL ê³µìœ </button>
    <button class="btn btn-primary" onclick="saveData()">ì €ì¥</button>
  </div>
</div>

<!-- Share Toast -->
<div class="toast" id="toast">
  <div class="toast-title">ğŸ”— ê³µìœ  URLì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤</div>
  <div class="toast-url" id="toastURL" onclick="copyURL()">í´ë¦­í•˜ì—¬ ë³µì‚¬</div>
  <div class="toast-hint">ë§í¬ë¥¼ í†µí•´ í˜„ì¬ ê³„íšì•ˆì„ ê·¸ëŒ€ë¡œ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
</div>

<div class="container">

  <!-- Section 1: Calendar -->
  <div class="section-header">
    <span class="section-tag">01</span>
    <h2 class="section-title">ì›” í”„ë¡œëª¨ì…˜ ìº˜ë¦°ë”</h2>
    <div class="section-divider"></div>
  </div>

  <div class="calendar-wrap">
    <div class="calendar-header">
      <div class="calendar-month-title" id="calTitle">2025 JUNE</div>
      <div class="cal-legend" id="calLegend">
        <div class="legend-hint">
          <span class="legend-chip-ev">ì´ë²¤íŠ¸</span> ì±„ìš´ ë°°ê²½
          &nbsp;
          <span class="legend-chip-ig">ğŸ“· ì¸ìŠ¤íƒ€ê·¸ë¨</span> ì ì„  í…Œë‘ë¦¬
          &nbsp;
          <span class="legend-chip-crm">ğŸ’Œ CRM</span> ì¤„ë¬´ëŠ¬ ì‹¤ì„ 
        </div>
      </div>
    </div>
    <div class="calendar-grid" id="calGrid"></div>
  </div>

  <!-- Section 2: Events -->
  <div class="section-header">
    <span class="section-tag">02</span>
    <h2 class="section-title">ì´ë²¤íŠ¸ í”„ë¡œëª¨ì…˜ ìš´ì˜ ìƒì„¸ì•ˆ</h2>
    <div class="section-divider"></div>
  </div>

  <div class="events-list" id="eventsGrid"></div>

</div>

<!-- Chip Add Modal -->
<div class="modal-overlay" id="chipModal">
  <div class="modal">
    <div class="modal-title">ìº˜ë¦°ë” ì¼ì • ì¶”ê°€</div>

    <div class="field-group">
      <label class="field-label">ì¼ì • ì¢…ë¥˜</label>
      <div class="type-toggle">
        <input type="radio" name="chipType" id="typeEvent" value="event" checked>
        <label for="typeEvent">ğŸ¯ ì´ë²¤íŠ¸</label>
        <input type="radio" name="chipType" id="typeIG" value="ig">
        <label for="typeIG">ğŸ“· ì¸ìŠ¤íƒ€ê·¸ë¨</label>
        <input type="radio" name="chipType" id="typeCRM" value="crm">
        <label for="typeCRM">ğŸ’Œ CRM</label>
      </div>
    </div>

    <div class="field-group">
      <label class="field-label">ë‚´ìš© <span style="font-size:10px;color:var(--text-light);letter-spacing:0">(ìµœëŒ€ 2ì¤„ í‘œì‹œ)</span></label>
      <input class="field-input" id="chipText" placeholder="ì¼ì • ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div class="field-group">
      <label class="field-label">ìƒ‰ìƒ ì„ íƒ</label>
      <div class="color-picker-row" id="chipColorPicker"></div>
      <div class="color-note" id="colorNote">
        <span>ë™ì¼ ìƒ‰ìƒ, ëª¨ì–‘ìœ¼ë¡œ êµ¬ë¶„ |</span>
        <span class="color-note-chip" id="previewEv" style="background:rgba(232,132,90,0.2);color:#c06030">ì´ë²¤íŠ¸ ì±„ìš´ë°°ê²½</span>
        <span class="color-note-chip" id="previewIg" style="border:1.5px dashed #e8845a;color:#e8845a">ì¸ìŠ¤íƒ€ê·¸ë¨ ì ì„ </span>
        <span class="color-note-chip" id="previewCrm" style="border:1.5px solid #e8845a;color:#e8845a;font-weight:600">CRM ì‹¤ì„ </span>
      </div>
    </div>

    <div class="field-group">
      <label class="field-label">ê¸°ê°„ (ì‹œì‘ì¼ ~ ì¢…ë£Œì¼)</label>
      <div class="field-row">
        <input class="field-input" type="number" id="chipStartDay" placeholder="ì‹œì‘ì¼" min="1" max="31">
        <input class="field-input" type="number" id="chipEndDay" placeholder="ì¢…ë£Œì¼" min="1" max="31">
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeChipModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" onclick="confirmChip()">ì¶”ê°€</button>
    </div>
  </div>
</div>

<!-- Hidden file input -->
<input type="file" id="imgFileInput" accept="image/*" style="display:none">

<!-- Chip Edit Modal -->
<div class="modal-overlay" id="chipEditModal">
  <div class="modal">
    <div class="modal-title">ì¼ì • ìˆ˜ì •</div>

    <div class="field-group">
      <label class="field-label">ì¼ì • ì¢…ë¥˜</label>
      <div class="type-toggle">
        <input type="radio" name="editChipType" id="editTypeEvent" value="event" checked>
        <label for="editTypeEvent">ğŸ¯ ì´ë²¤íŠ¸</label>
        <input type="radio" name="editChipType" id="editTypeIG" value="ig">
        <label for="editTypeIG">ğŸ“· ì¸ìŠ¤íƒ€ê·¸ë¨</label>
        <input type="radio" name="editChipType" id="editTypeCRM" value="crm">
        <label for="editTypeCRM">ğŸ’Œ CRM</label>
      </div>
    </div>

    <div class="field-group">
      <label class="field-label">ë‚´ìš©</label>
      <input class="field-input" id="editChipText" placeholder="ì¼ì • ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
    </div>

    <div class="field-group">
      <label class="field-label">ìƒ‰ìƒ ì„ íƒ</label>
      <div class="color-picker-row" id="editChipColorPicker"></div>
    </div>

    <div class="field-group">
      <label class="field-label">ê¸°ê°„ (ì‹œì‘ì¼ ~ ì¢…ë£Œì¼)</label>
      <div class="field-row">
        <input class="field-input" type="number" id="editChipStartDay" placeholder="ì‹œì‘ì¼" min="1" max="31">
        <input class="field-input" type="number" id="editChipEndDay" placeholder="ì¢…ë£Œì¼" min="1" max="31">
      </div>
    </div>

    <div class="modal-footer" style="justify-content:space-between">
      <button class="btn" id="chipDelBtn" style="background:#ffeaea;border:1px solid #e8a0a0;color:#c83030" onclick="deleteEditingChip()">ğŸ—‘ ì‚­ì œ</button>
      <div style="display:flex;gap:10px">
        <button class="btn btn-outline" onclick="closeChipEditModal()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="confirmEditChip()">ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<div class="page-footer">
  PROMO PLAN &nbsp;Â·&nbsp; ì‹¤ì‹œê°„ í´ë¼ìš°ë“œ ë™ê¸°í™” â˜ï¸ &nbsp;Â·&nbsp; íŒ€ì›ë“¤ê³¼ ë™ì‹œ ì‘ì—… ê°€ëŠ¥
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Firebase ì´ˆê¸°í™”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyATY4SxRKife6Iscv17qj6vbNzGdId2pLQ",
  authDomain: "promo-plan-c7b51.firebaseapp.com",
  projectId: "promo-plan-c7b51",
  storageBucket: "promo-plan-c7b51.firebasestorage.app",
  messagingSenderId: "343406084043",
  appId: "1:343406084043:web:7eecfbb8e309427217c04e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// í˜„ì¬ ë¬¸ì„œ ID (ë…„-ì›” ê¸°ì¤€ìœ¼ë¡œ ë¬¸ì„œ ë¶„ë¦¬)
function getDocId() {
  return `${state.year}-${String(state.month + 1).padStart(2, '0')}`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Shared color palette
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SHARED_COLORS = [
  '#e8845a','#7ab88c','#8a7ec8','#c87a9a',
  '#7ab8c8','#c8a870','#5a8ae8','#c85a5a'
];

let state = {
  year:  new Date().getFullYear(),
  month: new Date().getMonth(),
  chips:  [],   // { id, year, month, day, endDay, text, color, type }
  events: []    // { id, year, month, color, title, period, purpose, target, detail, refHtml }
};

let chipModalDay     = null;
let chipColorSelected = SHARED_COLORS[0];
let saveTimeout      = null;
let activeRefEditor  = null;   // currently focused ref editor

const DAY_LABELS   = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
const MONTH_NAMES  = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE',
                      'JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  // year select
  const yearSel = document.getElementById('yearSel');
  const cy = new Date().getFullYear();
  for (let y = cy - 1; y <= cy + 2; y++) {
    const o = document.createElement('option');
    o.value = y; o.textContent = y + 'ë…„';
    if (y === cy) o.selected = true;
    yearSel.appendChild(o);
  }

  // ì—°Â·ì›” ë³€ê²½ ì‹œ Firebaseì—ì„œ í•´ë‹¹ ë‹¬ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
  yearSel.addEventListener('change', async () => {
    state.year = +yearSel.value;
    await loadData();
    renderCalendar();
    renderEvents();
    setupRealtimeListener();
  });
  document.getElementById('monthSel').addEventListener('change', async e => {
    state.month = +e.target.value;
    await loadData();
    renderCalendar();
    renderEvents();
    setupRealtimeListener();
  });

  await loadData();
  document.getElementById('monthSel').value = state.month;
  for (let i = 0; i < yearSel.options.length; i++) {
    if (+yearSel.options[i].value === state.year) { yearSel.selectedIndex = i; break; }
  }

  // global paste (images â†’ active ref editor)
  document.addEventListener('paste', handleGlobalPaste);

  // file input â†’ image insert
  document.getElementById('imgFileInput').addEventListener('change', function() {
    if (!activeRefEditor || !this.files[0]) return;
    insertImageIntoRef(activeRefEditor, this.files[0]);
    this.value = '';
  });

  renderCalendar();
  renderEvents();

  // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  setupRealtimeListener();
}

// ì‹¤ì‹œê°„ ë™ê¸°í™” ë¦¬ìŠ¤ë„ˆ
let unsubscribe = null;
function setupRealtimeListener() {
  // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ
  if (unsubscribe) unsubscribe();

  const docId = getDocId();
  unsubscribe = db.collection('plans').doc(docId).onSnapshot(doc => {
    if (doc.exists && !doc.metadata.hasPendingWrites) {
      // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ìˆ˜ì •í•œ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
      const data = doc.data();
      const newChips = data.chips || [];
      const newEvents = data.events || [];

      // í˜„ì¬ ìƒíƒœì™€ ë¹„êµí•´ì„œ ë‹¤ë¥¼ ë•Œë§Œ ê°±ì‹ 
      if (JSON.stringify(state.chips) !== JSON.stringify(newChips) ||
          JSON.stringify(state.events) !== JSON.stringify(newEvents)) {
        state.chips = newChips;
        state.events = newEvents;
        renderCalendar();
        renderEvents();
        console.log('ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë°˜ì˜ë¨');
      }
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Calendar render
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCalendar() {
  const { year, month } = state;
  document.getElementById('calTitle').textContent = `${year} ${MONTH_NAMES[month]}`;

  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';

  // day labels
  DAY_LABELS.forEach(d => {
    const el = document.createElement('div');
    el.className = 'cal-day-label'; el.textContent = d;
    grid.appendChild(el);
  });

  const firstDay    = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const today       = new Date();

  // empty prefix cells
  for (let i = 0; i < firstDay; i++) {
    const el = document.createElement('div');
    el.className = 'cal-cell empty'; grid.appendChild(el);
  }

  // day cells
  for (let d = 1; d <= daysInMonth; d++) {
    const cell = document.createElement('div');
    cell.className = 'cal-cell';
    if (today.getFullYear()===year && today.getMonth()===month && today.getDate()===d)
      cell.classList.add('today');

    const num = document.createElement('span');
    num.className = 'day-num'; num.textContent = d;
    cell.appendChild(num);

    const evtWrap = document.createElement('div');
    evtWrap.className = 'cal-events';

    // chips â€” í˜„ì¬ ì—°Â·ì›”ì— í•´ë‹¹í•˜ëŠ” ê²ƒë§Œ í‘œì‹œ
    state.chips.forEach(chip => {
      if (chip.year !== state.year || chip.month !== state.month) return;

      const s = chip.day, e = chip.endDay || chip.day;
      if (d < s || d > e) return;

      const el = document.createElement('div');
      el.className = 'cal-event-chip type-' + chip.type;

      if (chip.type === 'event') {
        // ì±„ìš´ ë°°ê²½
        el.style.background   = chip.color + '28';
        el.style.color        = chip.color;
        el.style.borderLeft   = d === s ? `3px solid ${chip.color}` : '3px solid transparent';
        el.style.borderRadius = d === s ? '4px 2px 2px 4px' : d === e ? '2px 4px 4px 2px' : '2px';
      } else if (chip.type === 'crm') {
        // ì‹¤ì„  í…Œë‘ë¦¬ + ì¤„ë¬´ëŠ¬ ë°°ê²½
        el.style.borderColor  = chip.color;
        el.style.color        = chip.color;
        el.style.background   = `repeating-linear-gradient(45deg, ${chip.color}18, ${chip.color}18 3px, transparent 3px, transparent 7px)`;
        el.style.borderRadius = d === s ? '4px 2px 2px 4px' : d === e ? '2px 4px 4px 2px' : '2px';
      } else {
        // ì ì„  í…Œë‘ë¦¬ (ì¸ìŠ¤íƒ€ê·¸ë¨)
        el.style.borderColor  = chip.color;
        el.style.color        = chip.color;
        el.style.borderRadius = d === s ? '4px 2px 2px 4px' : d === e ? '2px 4px 4px 2px' : '2px';
      }

      // ì‹œì‘ì¼ì—ë§Œ í…ìŠ¤íŠ¸, ì´í›„ëŠ” íƒ€ì…ë³„ ì•„ì´ì½˜ ë˜ëŠ” ë¹ˆ bar
      if (d === s) {
        el.textContent = chip.text;
      } else {
        if (chip.type === 'ig')       el.textContent = 'ğŸ“·';
        else if (chip.type === 'crm') el.textContent = 'ğŸ’Œ';
        else                          el.textContent = '';
        el.style.minHeight = '18px';
      }

      const typeLabel = chip.type === 'ig' ? ' [ì¸ìŠ¤íƒ€ê·¸ë¨]' : chip.type === 'crm' ? ' [CRM]' : ' [ì´ë²¤íŠ¸]';
      el.title = chip.text + typeLabel + ' â€” í´ë¦­í•˜ì—¬ ìˆ˜ì •/ì‚­ì œ';
      el.addEventListener('click', (e) => { e.stopPropagation(); openChipEditModal(chip.id); });
      evtWrap.appendChild(el);
    });

    cell.appendChild(evtWrap);

    // + btn
    const addBtn = document.createElement('div');
    addBtn.className = 'add-event-btn'; addBtn.textContent = '+';
    addBtn.title = 'ì¼ì • ì¶”ê°€';
    addBtn.addEventListener('click', () => openChipModal(d));
    cell.appendChild(addBtn);

    grid.appendChild(cell);
  }

  renderLegend();
}

function renderLegend() {
  const leg = document.getElementById('calLegend');
  leg.querySelectorAll('.dyn-leg').forEach(e => e.remove());

  const seen = {};
  state.chips.forEach(c => {
    if (c.year !== state.year || c.month !== state.month) return;
    const key = c.text + '|' + c.type;
    if (seen[key]) return;
    seen[key] = true;
    const item = document.createElement('div');
    item.className = 'cal-legend-item dyn-leg';
    const dot = document.createElement('div');
    dot.className = 'legend-dot';

    if (c.type === 'ig') {
      dot.style.cssText = `width:10px;height:10px;border-radius:3px;border:1.5px dashed ${c.color};background:transparent;flex-shrink:0`;
    } else if (c.type === 'crm') {
      dot.style.cssText = `width:10px;height:10px;border-radius:3px;border:1.5px solid ${c.color};background:repeating-linear-gradient(45deg,${c.color}30,${c.color}30 2px,transparent 2px,transparent 5px);flex-shrink:0`;
    } else {
      dot.style.cssText = `width:10px;height:10px;border-radius:3px;background:${c.color}44;border-left:3px solid ${c.color};flex-shrink:0`;
    }

    const label = c.type === 'ig' ? 'ğŸ“· ' : c.type === 'crm' ? 'ğŸ’Œ ' : '';
    item.appendChild(dot);
    item.innerHTML += `<span>${label}${c.text}</span>`;
    item.insertBefore(dot, item.firstChild);
    leg.appendChild(item);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Chip Modal
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openChipModal(day) {
  chipModalDay = day;
  document.getElementById('chipText').value = '';
  document.getElementById('chipStartDay').value = day;
  document.getElementById('chipEndDay').value   = day;
  chipColorSelected = SHARED_COLORS[0];
  renderChipColorPicker();
  document.getElementById('typeEvent').checked = true;
  document.getElementById('chipModal').classList.add('show');
  setTimeout(() => document.getElementById('chipText').focus(), 120);
}

function closeChipModal() {
  document.getElementById('chipModal').classList.remove('show');
}

function renderChipColorPicker() {
  const wrap = document.getElementById('chipColorPicker');
  wrap.innerHTML = '';
  SHARED_COLORS.forEach((c, i) => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (i === 0 ? ' active' : '');
    sw.style.background = c;
    sw.addEventListener('click', () => {
      wrap.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      sw.classList.add('active');
      chipColorSelected = c;
      // update preview chips in modal
      document.getElementById('previewEv').style.cssText  = `padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:${c}28;color:${c}`;
      document.getElementById('previewIg').style.cssText  = `padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;border:1.5px dashed ${c};color:${c}`;
      document.getElementById('previewCrm').style.cssText = `padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;border:1.5px solid ${c};color:${c}`;
    });
    wrap.appendChild(sw);
  });
}

function confirmChip() {
  const text = document.getElementById('chipText').value.trim();
  if (!text) { document.getElementById('chipText').focus(); return; }
  const type  = document.querySelector('input[name="chipType"]:checked').value;
  const start = +document.getElementById('chipStartDay').value || chipModalDay;
  const end   = Math.max(start, +document.getElementById('chipEndDay').value || start);
  state.chips.push({
    id: Date.now(),
    year: state.year,
    month: state.month,
    day: start, endDay: end,
    text, color: chipColorSelected, type
  });
  closeChipModal();
  renderCalendar();
  scheduleSave();
}

function removeChip(id) {
  state.chips = state.chips.filter(c => c.id !== id);
  renderCalendar(); scheduleSave();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Chip Edit Modal
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editingChipId = null;
let editChipColorSelected = SHARED_COLORS[0];

function openChipEditModal(chipId) {
  const chip = state.chips.find(c => c.id === chipId);
  if (!chip) return;
  editingChipId = chipId;
  editChipColorSelected = chip.color;

  document.getElementById('editChipText').value = chip.text;
  document.getElementById('editChipStartDay').value = chip.day;
  document.getElementById('editChipEndDay').value = chip.endDay || chip.day;

  // type radio
  if (chip.type === 'ig') {
    document.getElementById('editTypeIG').checked = true;
  } else if (chip.type === 'crm') {
    document.getElementById('editTypeCRM').checked = true;
  } else {
    document.getElementById('editTypeEvent').checked = true;
  }

  // color picker
  renderEditChipColorPicker(chip.color);

  document.getElementById('chipEditModal').classList.add('show');
  setTimeout(() => document.getElementById('editChipText').focus(), 120);
}

function closeChipEditModal() {
  document.getElementById('chipEditModal').classList.remove('show');
  editingChipId = null;
  chipDelConfirmPending = false;
  const btn = document.getElementById('chipDelBtn');
  if (btn) {
    btn.textContent = 'ğŸ—‘ ì‚­ì œ';
    btn.style.background = '#ffeaea';
    btn.style.color = '#c83030';
    btn.style.borderColor = '#e8a0a0';
  }
}

function renderEditChipColorPicker(selectedColor) {
  const wrap = document.getElementById('editChipColorPicker');
  wrap.innerHTML = '';
  SHARED_COLORS.forEach(c => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (c === selectedColor ? ' active' : '');
    sw.style.background = c;
    sw.addEventListener('click', () => {
      wrap.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      sw.classList.add('active');
      editChipColorSelected = c;
    });
    wrap.appendChild(sw);
  });
}

function confirmEditChip() {
  const text = document.getElementById('editChipText').value.trim();
  if (!text) { document.getElementById('editChipText').focus(); return; }
  const type  = document.querySelector('input[name="editChipType"]:checked').value;
  const start = +document.getElementById('editChipStartDay').value;
  const end   = Math.max(start, +document.getElementById('editChipEndDay').value || start);

  const chip = state.chips.find(c => c.id === editingChipId);
  if (chip) {
    chip.text   = text;
    chip.type   = type;
    chip.color  = editChipColorSelected;
    chip.day    = start;
    chip.endDay = end;
    // year/month ë³´ì¡´ (ì—†ìœ¼ë©´ í˜„ì¬ ë‹¬ë¡œ ì„¸íŒ…)
    if (chip.year  == null) chip.year  = state.year;
    if (chip.month == null) chip.month = state.month;
  }
  closeChipEditModal();
  renderCalendar();
  scheduleSave();
}

let chipDelConfirmPending = false;

function deleteEditingChip() {
  if (!editingChipId) return;
  const btn = document.getElementById('chipDelBtn');
  if (!chipDelConfirmPending) {
    // first click â€” ask for confirmation via button text change
    chipDelConfirmPending = true;
    btn.textContent = 'ì •ë§ ì‚­ì œí• ê¹Œìš”?';
    btn.style.background = '#c83030';
    btn.style.color = '#fff';
    btn.style.borderColor = '#c83030';
    setTimeout(() => {
      // auto-reset after 3s if not clicked again
      if (chipDelConfirmPending) {
        chipDelConfirmPending = false;
        btn.textContent = 'ğŸ—‘ ì‚­ì œ';
        btn.style.background = '#ffeaea';
        btn.style.color = '#c83030';
        btn.style.borderColor = '#e8a0a0';
      }
    }, 3000);
    return;
  }
  // second click â€” actually delete
  chipDelConfirmPending = false;
  const idToDelete = editingChipId;
  closeChipEditModal();
  setTimeout(() => { removeChip(idToDelete); }, 50);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Event Cards
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEvents() {
  const list = document.getElementById('eventsGrid');
  list.innerHTML = '';

  // í˜„ì¬ ì—°Â·ì›”ì— í•´ë‹¹í•˜ëŠ” ì´ë²¤íŠ¸ë§Œ í‘œì‹œ
  const filtered = state.events.filter(ev =>
    ev.year === state.year && ev.month === state.month
  );

  filtered.forEach((ev, idx) => list.appendChild(createEventCard(ev, idx)));

  const addCard = document.createElement('div');
  addCard.className = 'add-event-card';
  addCard.innerHTML = `<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> ìƒˆ ì´ë²¤íŠ¸ ì¶”ê°€`;
  addCard.addEventListener('click', addEvent);
  list.appendChild(addCard);
}

function createEventCard(ev, idx) {
  const card = document.createElement('div');
  card.className = 'event-card';
  card.dataset.id = ev.id;

  const safeRefHtml = ev.refHtml || '';
  const refIsEmpty  = !ev.refHtml || ev.refHtml.replace(/<[^>]*>/g,'').trim() === '';

  card.innerHTML = `
    <div class="event-card-top" style="background:${ev.color}"></div>
    <div class="event-card-inner">

      <!-- LEFT -->
      <div class="event-card-left">
        <div class="event-card-header">
          <span class="event-number">0${idx+1}</span>
          <div class="event-title-block">
            <div class="event-theme-tag">EVENT THEME</div>
            <input class="event-title-input" placeholder="ì´ë²¤íŠ¸ íƒ€ì´í‹€ì„ ì…ë ¥í•˜ì„¸ìš”"
              value="${escHtml(ev.title)}" data-field="title">
          </div>
          <button class="event-del-btn" title="ì‚­ì œ">âœ•</button>
        </div>

        <div class="field-group">
          <label class="field-label">ì´ë²¤íŠ¸ ì»¬ëŸ¬</label>
          <div class="color-picker-row" id="evColor_${ev.id}"></div>
        </div>

        <div class="field-row">
          <div class="field-group">
            <label class="field-label">ìš´ì˜ ê¸°ê°„</label>
            <input class="field-input" placeholder="ì˜ˆ: 6/1 ~ 6/7"
              value="${escHtml(ev.period)}" data-field="period">
          </div>
          <div class="field-group">
            <label class="field-label">íƒ€ê²Ÿ</label>
            <input class="field-input" placeholder="ì˜ˆ: 20-30ëŒ€ ì—¬ì„±"
              value="${escHtml(ev.target)}" data-field="target">
          </div>
        </div>

        <div class="field-group">
          <label class="field-label">ëª©ì </label>
          <input class="field-input" placeholder="ì´ë²¤íŠ¸ì˜ ëª©ì  ë° KPIë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            value="${escHtml(ev.purpose)}" data-field="purpose">
        </div>

        <div class="field-group">
          <label class="field-label">ìš´ì˜ ìƒì„¸ ë‚´ìš©</label>
          <textarea class="field-textarea" rows="7"
            placeholder="ì´ë²¤íŠ¸ ì§„í–‰ ë°©ì‹, í˜œíƒ, ì¡°ê±´ ë“± ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"
            data-field="detail">${escHtml(ev.detail)}</textarea>
        </div>
      </div>

      <!-- RIGHT: ë ˆí¼ëŸ°ìŠ¤ ë©”ëª¨ -->
      <div class="event-card-right">
        <div class="ref-panel-title">ğŸ“Œ ë ˆí¼ëŸ°ìŠ¤ ë©”ëª¨</div>
        <div class="ref-toolbar">
          <button class="ref-tool-btn" data-action="img">ğŸ–¼ ì´ë¯¸ì§€ ì¶”ê°€</button>
          <button class="ref-tool-btn" data-action="hr">â€” êµ¬ë¶„ì„ </button>
          <button class="ref-tool-btn" data-action="bold"><b>B</b> êµµê²Œ</button>
          <button class="ref-tool-btn" data-action="ul">â€¢ ëª©ë¡</button>
        </div>
        <div class="ref-editor"
          contenteditable="true"
          data-evid="${ev.id}"
          data-placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë¶™ì—¬ë„£ê¸°(Ctrl+V) ë˜ëŠ” ë“œë˜ê·¸&amp;ë“œë¡­ í•˜ì„¸ìš”.

â€¢ ì°¸ê³  URL, ë ˆí¼ëŸ°ìŠ¤ ë§í¬
â€¢ ê¸°íš ë©”ëª¨, ì•„ì´ë””ì–´
â€¢ ìº¡ì²˜ ì´ë¯¸ì§€"
          data-empty="${refIsEmpty ? 'true' : 'false'}"
        >${safeRefHtml}</div>
      </div>

    </div>
  `;

  // color picker
  const colorWrap = card.querySelector(`#evColor_${ev.id}`);
  SHARED_COLORS.forEach(c => {
    const sw = document.createElement('div');
    sw.className = 'color-swatch' + (c === ev.color ? ' active' : '');
    sw.style.background = c;
    sw.addEventListener('click', () => {
      colorWrap.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      sw.classList.add('active');
      ev.color = c;
      card.querySelector('.event-card-top').style.background = c;
      scheduleSave();
    });
    colorWrap.appendChild(sw);
  });

  // delete â€” 2ë‹¨ê³„ í™•ì¸ (confirm()ì€ sandbox í™˜ê²½ì—ì„œ ë™ì‘ ì•ˆ í•¨)
  const delBtn = card.querySelector('.event-del-btn');
  let delPending = false;
  delBtn.addEventListener('click', () => {
    if (!delPending) {
      delPending = true;
      delBtn.textContent = 'ì‚­ì œ?';
      delBtn.style.background = '#c83030';
      delBtn.style.color = '#fff';
      delBtn.style.borderColor = '#c83030';
      setTimeout(() => {
        if (delPending) {
          delPending = false;
          delBtn.textContent = 'âœ•';
          delBtn.style.background = '';
          delBtn.style.color = '';
          delBtn.style.borderColor = '';
        }
      }, 3000);
    } else {
      state.events = state.events.filter(e => e.id !== ev.id);
      renderEvents(); scheduleSave();
    }
  });

  // text fields + auto-grow textarea
  card.querySelectorAll('[data-field]').forEach(el => {
    el.addEventListener('input', () => {
      ev[el.dataset.field] = el.value;
      // auto-grow for textarea
      if (el.tagName === 'TEXTAREA') {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      }
      scheduleSave();
    });
    // init height on load
    if (el.tagName === 'TEXTAREA' && el.value) {
      requestAnimationFrame(() => {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
      });
    }
  });

  // ref editor
  const refEditor = card.querySelector('.ref-editor');

  refEditor.addEventListener('focus', () => {
    activeRefEditor = refEditor;
    refEditor.dataset.empty = 'false';
  });
  refEditor.addEventListener('blur', () => {
    const hasContent = refEditor.textContent.trim() !== '' || refEditor.querySelector('img');
    refEditor.dataset.empty = hasContent ? 'false' : 'true';
    ev.refHtml = refEditor.innerHTML;
    scheduleSave();
  });
  refEditor.addEventListener('input', () => {
    ev.refHtml = refEditor.innerHTML;
    scheduleSave();
  });

  // drag & drop
  refEditor.addEventListener('dragover', e => {
    e.preventDefault();
    refEditor.style.outline = '2px dashed var(--accent2)';
    refEditor.style.outlineOffset = '-2px';
  });
  refEditor.addEventListener('dragleave', () => { refEditor.style.outline = ''; });
  refEditor.addEventListener('drop', e => {
    e.preventDefault();
    refEditor.style.outline = '';
    activeRefEditor = refEditor;
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) insertImageIntoRef(refEditor, file);
  });

  // toolbar
  card.querySelectorAll('.ref-tool-btn').forEach(btn => {
    btn.addEventListener('mousedown', e => {
      e.preventDefault(); // keep focus in editor
    });
    btn.addEventListener('click', () => {
      activeRefEditor = refEditor;
      refEditor.focus();
      const action = btn.dataset.action;
      if      (action === 'img')  document.getElementById('imgFileInput').click();
      else if (action === 'hr')   document.execCommand('insertHTML', false, '<hr style="border:none;border-top:1px solid #ddd;margin:10px 0"><br>');
      else if (action === 'bold') document.execCommand('bold');
      else if (action === 'ul')   document.execCommand('insertUnorderedList');
      ev.refHtml = refEditor.innerHTML;
      scheduleSave();
    });
  });

  return card;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Image insert
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function insertImageIntoRef(editor, file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = document.createElement('img');
    img.src = e.target.result;
    img.title = 'í´ë¦­í•˜ì—¬ ì‚­ì œ';
    img.addEventListener('click', () => {
      if (confirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?')) {
        img.remove();
        const evId = +editor.dataset.evid;
        const ev   = state.events.find(ev => ev.id === evId);
        if (ev) { ev.refHtml = editor.innerHTML; scheduleSave(); }
      }
    });

    const sel = window.getSelection();
    if (sel && sel.rangeCount > 0 && editor.contains(sel.anchorNode)) {
      const range = sel.getRangeAt(0);
      range.deleteContents();
      range.insertNode(img);
      range.setStartAfter(img);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    } else {
      editor.appendChild(img);
    }

    editor.dataset.empty = 'false';
    const evId = +editor.dataset.evid;
    const ev   = state.events.find(ev => ev.id === evId);
    if (ev) { ev.refHtml = editor.innerHTML; scheduleSave(); }
  };
  reader.readAsDataURL(file);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Global paste â†’ image
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleGlobalPaste(e) {
  if (!activeRefEditor) return;
  const items = e.clipboardData && e.clipboardData.items;
  if (!items) return;
  for (let i = 0; i < items.length; i++) {
    if (items[i].type.startsWith('image/')) {
      e.preventDefault();
      insertImageIntoRef(activeRefEditor, items[i].getAsFile());
      return;
    }
  }
}

function addEvent() {
  const newEv = {
    id: Date.now(),
    year: state.year,
    month: state.month,
    color: SHARED_COLORS[state.events.filter(e => e.year === state.year && e.month === state.month).length % SHARED_COLORS.length],
    title: '', period: '', purpose: '', target: '', detail: '', refHtml: ''
  };
  state.events.push(newEv);
  renderEvents(); scheduleSave();
  setTimeout(() => {
    const cards = document.querySelectorAll('.event-card');
    cards[cards.length - 1]?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Save / Load
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scheduleSave() {
  document.getElementById('saveDot').classList.add('saving');
  document.getElementById('saveLabel').textContent = 'ì €ì¥ ì¤‘...';
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveData, 1200);
}

async function saveData() {
  document.getElementById('saveDot').classList.remove('saving');
  document.getElementById('saveLabel').textContent = 'ì €ì¥ ì¤‘...';
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const ts = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  document.getElementById('saveTime').textContent = ts;

  // Firebaseì— ì €ì¥
  try {
    const docId = getDocId();
    await db.collection('plans').doc(docId).set({
      year: state.year,
      month: state.month,
      chips: state.chips,
      events: state.events,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    document.getElementById('saveLabel').textContent = 'ì €ì¥ë¨ â˜ï¸';
  } catch(e) {
    console.error('Firebase ì €ì¥ ì˜¤ë¥˜:', e);
    document.getElementById('saveLabel').textContent = 'ì €ì¥ ì‹¤íŒ¨';
    // ë¡œì»¬ ë°±ì—…
    try { localStorage.setItem('promoplan_v2', JSON.stringify(state)); } catch(e2) {}
  }
}

async function loadData() {
  // URL í•´ì‹œ ìš°ì„  (ê³µìœ  ë§í¬)
  if (location.hash && location.hash.length > 1) {
    try {
      state = JSON.parse(decodeURIComponent(atob(location.hash.slice(1))));
      migrateData();
      return;
    } catch(e) {}
  }

  // Firebaseì—ì„œ ë¡œë“œ
  try {
    const docId = getDocId();
    const doc = await db.collection('plans').doc(docId).get();

    if (doc.exists) {
      const data = doc.data();
      state.chips = data.chips || [];
      state.events = data.events || [];
      migrateData();
      console.log('Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
    } else {
      // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í™•ì¸
      const s = localStorage.getItem('promoplan_v2');
      if (s) {
        state = JSON.parse(s);
        migrateData();
      }
    }
  } catch(e) {
    console.error('Firebase ë¡œë“œ ì˜¤ë¥˜:', e);
    // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ í´ë°±
    try {
      const s = localStorage.getItem('promoplan_v2');
      if (s) { state = JSON.parse(s); migrateData(); }
    } catch(e2) {}
  }
}

// ê¸°ì¡´ ë°ì´í„°(year/month ì—†ëŠ” ê²ƒ)ì— í˜„ì¬ ì—°Â·ì›”ì„ ë¶€ì—¬í•´ ë§ˆì´ê·¸ë ˆì´ì…˜
function migrateData() {
  const y = state.year, m = state.month;
  state.chips.forEach(c => {
    if (c.year  == null) c.year  = y;
    if (c.month == null) c.month = m;
  });
  state.events.forEach(ev => {
    if (ev.year  == null) ev.year  = y;
    if (ev.month == null) ev.month = m;
  });
}

function clearAll() {
  if (!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;
  state.chips = []; state.events = [];
  renderCalendar(); renderEvents(); saveData();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   Share URL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function shareURL() {
  saveData();
  const encoded = btoa(encodeURIComponent(JSON.stringify(state)));
  const url = location.origin + location.pathname + '#' + encoded;
  history.replaceState(null, '', '#' + encoded);
  const toastURL = document.getElementById('toastURL');
  toastURL.textContent = url.length > 80 ? url.slice(0, 77) + '...' : url;
  toastURL.dataset.full = url;
  document.getElementById('toast').classList.add('show');
  setTimeout(() => document.getElementById('toast').classList.remove('show'), 6000);
}

function copyURL() {
  const url = document.getElementById('toastURL').dataset.full;
  if (!url) return;
  navigator.clipboard.writeText(url).then(() => {
    document.getElementById('toastURL').textContent = 'âœ“ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!';
  });
}

function escHtml(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
